name: Example Private Module Usage

# This is a template workflow - update the URLs before using
# Change to 'push' trigger after deploying the proxy
on:
  workflow_dispatch:  # Manual trigger only

permissions:
  id-token: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Get OIDC Token
        id: token
        run: |
          # TODO: Replace goproxy.example.com with your deployed proxy URL
          # Request OIDC token with the proxy's audience
          TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=https://goproxy.example.com" \
            | jq -r .value)

          # Mask the token in logs
          echo "::add-mask::$TOKEN"

          # Export for later use
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Configure Go proxy with authentication
        env:
          TOKEN: ${{ steps.token.outputs.token }}
        run: |
          # TODO: Replace goproxy.example.com with your deployed proxy URL
          # Configure Go to use the authenticated proxy
          echo "GOPROXY=https://goproxy.example.com" >> $GITHUB_ENV
          echo "GOAUTH=github.com/${{ github.repository }}=Bearer $TOKEN" >> $GITHUB_ENV

      - name: Download dependencies
        run: go mod download

      - name: Build
        run: go build -v ./...

      - name: Test
        run: go test -v ./...
